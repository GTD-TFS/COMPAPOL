<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>Filiaciones ¬∑ M√≥vil ¬∑ XLSX & ODT (Offline)</title>
<style>
  :root{
    --bg:#0f1220; --panel:#171a2b; --muted:#9aa3b2; --text:#e8ecf3;
    --border:#262a43; --radius:14px; --shadow:0 10px 30px rgba(0,0,0,.35);
    --accent:#2a3e7a; --accent-2:#364d9c;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family: system-ui, -apple-system, Segoe UI, Inter, Roboto, Arial;
    background: radial-gradient(1200px 700px at 10% -10%, #1b2140 0%, #0f1220 60%), var(--bg);
    color:var(--text);
  }
  .wrap{
    display:grid; grid-template-columns: 1fr; gap:12px; padding:12px;
    max-width: 960px; margin: 0 auto;
  }
  @media (min-width: 980px){
    .wrap{ grid-template-columns: 1fr 1fr; }
  }
  @media (min-width: 1280px){
    .wrap{ grid-template-columns: 380px 1fr 340px; }
  }

  .card{
    background: linear-gradient(180deg, #1a1f38 0%, #14182d 100%);
    border:1px solid var(--border);
    border-radius:var(--radius);
    box-shadow: var(--shadow);
  }
  .card .head{ padding:14px 14px 0 }
  .card .body{ padding:12px 14px 14px 14px }
  h2,h3{margin:0 0 8px}
  .muted{color:var(--muted)} .tiny{font-size:12px}

  .row{display:flex; gap:10px; flex-wrap:wrap}
  .col{flex:1 1 180px}
  label{display:block; font-size:12px; color:var(--muted); margin:4px 0 6px}
  input, textarea{
    width:100%; background:#10132a; color:var(--text); border:1px solid var(--border);
    border-radius:10px; padding:12px; font:inherit; outline:none;
  }
  input{height:44px}
  textarea{min-height:300px; line-height:1.5; resize:vertical}
  .btn{
    appearance:none; border:none; background:var(--accent); color:white; padding:10px 14px;
    border-radius:10px; cursor:pointer; font-weight:700; min-height:44px;
  }
  .btn:active{transform:translateY(1px)}
  .btn.secondary{background:#1a203c; color:var(--text); border:1px solid var(--border)}
  .btn.ghost{background:transparent; color:var(--muted); border:1px dashed var(--border)}
  .btn.danger{background:#7d2b2b}
  .btn.tiny{font-size:12px; padding:6px 8px; border-radius:8px; min-height:auto}
  .btn-row{display:flex; gap:8px; flex-wrap:wrap}

  /* Desplegables accesibles */
  details{
    background:#111630; border:1px solid var(--border); border-radius:12px; margin-bottom:10px;
    overflow:hidden;
  }
  summary{
    list-style:none; position:relative; padding:12px 44px 12px 12px; cursor:pointer; user-select:none;
    display:flex; align-items:center; gap:8px; min-height:44px;
  }
  summary::-webkit-details-marker{display:none}
  summary .tag{font-size:12px; color:#c8d1ff; background:#0e1230; border:1px solid var(--border); padding:3px 8px; border-radius:999px}
  summary .title{font-weight:700}
  summary .sub{font-size:12px; color:var(--muted)}
  summary .caret{
    position:absolute; right:12px; top:50%; transform:translateY(-50%) rotate(0deg);
    width:18px; height:18px; border:solid #90a0ff; border-width:0 2px 2px 0; display:inline-block;
    padding:3px; transform-origin:center; transition:transform .2s ease;
  }
  details[open] summary .caret{ transform:translateY(-50%) rotate(45deg) }
  .details-body{ padding:12px; border-top:1px solid var(--border) }

  /* Coletillas */
  .coletillas{ display:flex; flex-direction:column; gap:10px }
  .coletilla{
    display:flex; align-items:center; justify-content:space-between; gap:6px;
    background:#0f1433; border:1px solid var(--border); border-radius:10px; padding:10px;
  }
  .coletilla .txt{ font-size:14px; line-height:1.35; color:#d7dcef; word-break:break-word; flex:1}
  .pill{border:1px solid var(--border); border-radius:999px; padding:4px 8px; font-size:12px; color:var(--muted)}

  .dock{
    position:sticky; bottom:0; background:rgba(20,24,45,.92); border-top:1px solid var(--border);
    padding:10px 14px; display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;
    border-bottom-left-radius:var(--radius); border-bottom-right-radius:var(--radius)
  }
</style>
</head>
<body>
<div class="wrap">

  <!-- Panel 1: Filiaciones -->
  <section class="card">
    <div class="head">
      <h2>Filiaciones</h2>
      <p class="muted tiny">Exporta a XLSX (hoja ‚ÄúResumen‚Äù con 29 filas). Importa XLSX para crear fichas.</p>
    </div>
    <div class="body">
      <div class="btn-row" style="margin-bottom:8px">
        <button class="btn" id="addFBtn">‚ûï A√±adir filiaci√≥n</button>
        <button class="btn secondary" id="importXlsxBtn">üì• Importar XLSX</button>
        <input id="importXlsxInput" type="file" accept=".xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" multiple style="display:none" />
        <button class="btn secondary" id="clearFBtn" title="Borrar todas">üóëÔ∏è Limpiar</button>
      </div>
      <div id="filiaciones"></div>
      <p class="muted tiny">Consejo m√≥vil: toca el encabezado de cada ficha para desplegar/plegar.</p>
    </div>
  </section>

  <!-- Panel 2: Documento -->
  <section class="card">
    <div class="head">
      <h2>Documento</h2>
      <div class="pill">üíæ Guardado autom√°tico</div>
    </div>
    <div class="body">
      <label for="titulo">T√≠tulo</label>
      <input id="titulo" placeholder="Ej.: Diligencia de constancia" />
      <label for="doc">Contenido</label>
      <textarea id="doc" placeholder="Escribe aqu√≠ el contenido del documento..."></textarea>
      <div class="btn-row" style="margin-top:8px">
        <button class="btn secondary" id="copyBtn">üìã Copiar</button>
        <button class="btn secondary" id="odtBtn">‚¨áÔ∏è Exportar ODT</button>
        <button class="btn secondary" id="saveProjectBtn">üíº Guardar proyecto</button>
        <input type="file" id="loadProjectInput" accept="application/json" style="display:none" />
        <button class="btn secondary" id="loadProjectBtn">üìÇ Cargar proyecto</button>
        <button class="btn secondary" id="printBtn">üñ®Ô∏è Imprimir / PDF</button>
      </div>
    </div>
    <div class="dock">
      <span class="muted tiny">Variables: <code>{{fecha}}</code>, <code>{{hoy}}</code>, <code>{{titulo}}</code>.</span>
    </div>
  </section>

  <!-- Panel 3: Coletillas -->
  <section class="card">
    <div class="head">
      <h3>Coletillas</h3>
      <p class="muted tiny">Predeterminadas (no se pueden a√±adir nuevas).</p>
    </div>
    <div class="body">
      <details>
        <summary><span class="title">Insertar coletillas</span><span class="caret"></span></summary>
        <div class="details-body">
          <div class="coletillas" id="coletillas"></div>
        </div>
      </details>
    </div>
  </section>

</div>

<script>
/* =================== Utilidades =================== */
const $ = s=>document.querySelector(s);
const $$ = s=>Array.from(document.querySelectorAll(s));

function download(filename, data, type="application/octet-stream"){
  const blob = new Blob([data], {type});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click();
  setTimeout(()=>{URL.revokeObjectURL(url); a.remove();},0);
}
function toUTF8(s){ return new TextEncoder().encode(s); }
function fromUTF8(u8){ return new TextDecoder().decode(u8); }
function todayISO(){ const d=new Date(), pad=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
function applyVars(text){
  const map={"{{fecha}}": new Date().toLocaleDateString(), "{{hoy}}": todayISO(), "{{titulo}}": state.titulo||""};
  return text.replace(/{{\s*(fecha|hoy|titulo)\s*}}/g, m=>map[m]??m);
}
function escapeXml(s){
  return String(s??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;");
}
function insertAtCursor(textarea, text){
  const start = textarea.selectionStart ?? textarea.value.length;
  const end = textarea.selectionEnd ?? textarea.value.length;
  const before = textarea.value.slice(0,start), after = textarea.value.slice(end);
  textarea.value = before + text + after;
  const pos = start + text.length; textarea.selectionStart = textarea.selectionEnd = pos; textarea.focus();
}

/* =================== Estado =================== */
const LS_KEY="editor_filiaciones_mobile";
const state={filiaciones:[], titulo:"", doc:""};
function save(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }
function load(){ try{ Object.assign(state, JSON.parse(localStorage.getItem(LS_KEY)||"{}")); }catch{} }

/* =================== Modelo de filiaci√≥n (sin localidad/provincia) =================== */
function nuevaFiliacion(){
  return {
    nombre:"", apellidos:"", tipoDoc:"", dni:"", padres:"", domicilio:"", telefono:""
  };
}

/* =================== Coletillas predeterminadas (solo insertar) =================== */
const PREDEFINIDAS = [
  "Resulta conveniente hacer constar que se ha informado a las partes de sus derechos y obligaciones.",
  "Se advierte a la persona interesada de que la falta de respuesta en el plazo conferido podr√° entenderse como desistimiento.",
  "Queda unido a las actuaciones el escrito presentado, d√°ndose por reproducido su contenido a los efectos oportunos.",
  "Notif√≠quese a las partes personadas, con indicaci√≥n de los recursos que procedan."
];
function renderColetillas(){
  const cont=$("#coletillas"); cont.innerHTML="";
  PREDEFINIDAS.forEach(t=>{
    const el=document.createElement('div'); el.className="coletilla";
    el.innerHTML = `<div class="txt">${t.replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]))}</div>
                    <div><button class="btn secondary tiny">‚ûú</button></div>`;
    el.querySelector('button').onclick=()=>{ insertAtCursor($("#doc"), t+"\n"); persistDoc(); };
    cont.appendChild(el);
  });
}

/* =================== ZIP Writer (para XLSX/ODT) =================== */
function crc32(u8){ let c=~0>>>0; for(let i=0;i<u8.length;i++){ c=(c>>>8)^CRC_TABLE[(c^u8[i])&0xFF]; } return (~c)>>>0; }
const CRC_TABLE=(()=>{const t=new Uint32Array(256); for(let n=0;n<256;n++){let c=n; for(let k=0;k<8;k++){ c=(c&1)?(0xEDB88320^(c>>>1)):(c>>>1);} t[n]=c>>>0;} return t;})();
function dosDateTime(d=new Date()){
  const time=((d.getHours()<<11)|(d.getMinutes()<<5)|(Math.floor(d.getSeconds()/2)))&0xFFFF;
  const date=(((d.getFullYear()-1980)<<9)|((d.getMonth()+1)<<5)|d.getDate())&0xFFFF;
  return {time,date};
}
class ZipWriter{
  constructor(){ this.entries=[]; this.parts=[]; this.offset=0; }
  addFile(name, data){
    const nameBytes = toUTF8(name);
    const content = (typeof data==="string")? toUTF8(data) : (data instanceof Uint8Array? data : new Uint8Array(data));
    const {time,date}=dosDateTime(); const crc=crc32(content);
    const local=new Uint8Array(30+nameBytes.length); const v=new DataView(local.buffer);
    v.setUint32(0,0x04034b50,true); v.setUint16(4,20,true); v.setUint16(6,0,true); v.setUint16(8,0,true);
    v.setUint16(10,time,true); v.setUint16(12,date,true); v.setUint32(14,crc,true);
    v.setUint32(18,content.length,true); v.setUint32(22,content.length,true);
    v.setUint16(26,nameBytes.length,true); v.setUint16(28,0,true);
    local.set(nameBytes,30);
    const offsetHere=this.offset; this.parts.push(local,content); this.offset+=local.length+content.length;
    this.entries.push({nameBytes, crc, size:content.length, time, date, offset:offsetHere});
  }
  finalize(){
    const centralParts=[]; let centralSize=0;
    for(const e of this.entries){
      const c=new Uint8Array(46+e.nameBytes.length); const v=new DataView(c.buffer);
      v.setUint32(0,0x02014b50,true); v.setUint16(4,20,true); v.setUint16(6,20,true);
      v.setUint16(8,0,true); v.setUint16(10,0,true); v.setUint16(12,e.time,true); v.setUint16(14,e.date,true);
      v.setUint32(16,e.crc,true); v.setUint32(20,e.size,true); v.setUint32(24,e.size,true);
      v.setUint16(28,e.nameBytes.length,true); v.setUint16(30,0,true); v.setUint16(32,0,true);
      v.setUint16(34,0,true); v.setUint16(36,0,true); v.setUint32(38,0,true); v.setUint32(42,e.offset,true);
      c.set(e.nameBytes,46); centralParts.push(c); centralSize+=c.length;
    }
    const centralOffset=this.offset; this.parts.push(...centralParts); this.offset+=centralSize;
    const end=new Uint8Array(22); const ve=new DataView(end.buffer);
    ve.setUint32(0,0x06054b50,true); ve.setUint16(4,0,true); ve.setUint16(6,0,true);
    ve.setUint16(8,this.entries.length,true); ve.setUint16(10,this.entries.length,true);
    ve.setUint32(12,centralSize,true); ve.setUint32(16,centralOffset,true); ve.setUint16(20,0,true);
    this.parts.push(end);
    let total=0; for(const p of this.parts) total+=p.length;
    const out=new Uint8Array(total); let off=0; for(const p of this.parts){ out.set(p,off); off+=p.length; }
    return out;
  }
}

/* =================== ODT (texto) =================== */
function makeODT(title, body){
  const esc = s=>s.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&apos;'}[m]));
  const paragraphs = esc(applyVars(body)).split(/\n/).map(line=>`<text:p>${line||''}</text:p>`).join('');
  const content =
`<?xml version="1.0" encoding="UTF-8"?>
<office:document-content
 xmlns:office="urn:oasis:names:tc:opendocument:xmlns:office:1.0"
 xmlns:text="urn:oasis:names:tc:opendocument:xmlns:text:1.0"
 office:version="1.2">
 <office:body><office:text>
  <text:h text:outline-level="1">${esc(title||'Documento')}</text:h>
  ${paragraphs}
 </office:text></office:body>
</office:document-content>`;
  const manifest =
`<?xml version="1.0" encoding="UTF-8"?>
<manifest:manifest xmlns:manifest="urn:oasis:names:tc:opendocument:xmlns:manifest:1.0">
 <manifest:file-entry manifest:media-type="application/vnd.oasis.opendocument.text" manifest:full-path="/"/>
 <manifest:file-entry manifest:media-type="text/xml" manifest:full-path="content.xml"/>
</manifest:manifest>`;
  const z=new ZipWriter();
  z.addFile("mimetype","application/vnd.oasis.opendocument.text");
  z.addFile("content.xml", content);
  z.addFile("META-INF/manifest.xml", manifest);
  return z.finalize();
}

/* =================== XLSX (base ‚ÄúResumen‚Äù) =================== */
const XLSX_LABELS = [
  "Nombre","Apellidos","Tipo de documento","N¬∫ Documento","Sexo","Nacionalidad","Nombre de los Padres",
  "Fecha de nacimiento","Lugar de nacimiento","Domicilio","Tel√©fono","Delito","C.P. Agentes","Diligencias",
  "Instructor","Lugar del hecho","Lugar de la detenci√≥n","Hora del hecho","Hora de la detenci√≥n",
  "Breve resumen de los hechos","Indicios por los que se detiene","Abogado","Comunicarse con","Informar de detenci√≥n",
  "Int√©rprete","M√©dico","Consulado","Indicativo","Fecha de generaci√≥n"
];
function valueForLabel(f, label){
  switch(label){
    case "Nombre": return f.nombre||"";
    case "Apellidos": return f.apellidos||"";
    case "Tipo de documento": return f.tipoDoc||"";
    case "N¬∫ Documento": return f.dni||"";
    case "Nombre de los Padres": return f.padres||"";
    case "Domicilio": return f.domicilio||"";
    case "Tel√©fono": return f.telefono||"";
    case "Fecha de generaci√≥n": return ""; // ‚Üê en blanco como pediste
    default: return "";
  }
}
function sheetXMLForFiliacion(f){
  const rows = XLSX_LABELS.map((lab, idx)=>{
    const r = idx+1;
    const a = `<c r="A${r}" t="inlineStr"><is><t>${escapeXml(lab)}</t></is></c>`;
    const b = `<c r="B${r}" t="inlineStr"><is><t>${escapeXml(valueForLabel(f, lab))}</t></is></c>`;
    return `<row r="${r}">${a}${b}</row>`;
  }).join("");
  return `<?xml version="1.0" encoding="UTF-8"?>
<worksheet xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main">
  <dimension ref="A1:B${XLSX_LABELS.length}"/>
  <sheetData>${rows}</sheetData>
</worksheet>`;
}
function workbookXML(){
  return `<?xml version="1.0" encoding="UTF-8"?>
<workbook xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main"
 xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships">
  <sheets><sheet name="Resumen" sheetId="1" r:id="rId1"/></sheets>
</workbook>`;
}
function workbookRelsXML(){
  return `<?xml version="1.0" encoding="UTF-8"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
  <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/worksheet" Target="worksheets/sheet1.xml"/>
</Relationships>`;
}
function rootRelsXML(){
  return `<?xml version="1.0" encoding="UTF-8"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
  <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="xl/workbook.xml"/>
  <Relationship Id="rId2" Type="http://schemas.openxmlformats.org/package/2006/relationships/metadata/core-properties" Target="docProps/core.xml"/>
  <Relationship Id="rId3" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/extended-properties" Target="docProps/app.xml"/>
</Relationships>`;
}
function contentTypesXML(){
  return `<?xml version="1.0" encoding="UTF-8"?>
<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">
  <Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>
  <Default Extension="xml" ContentType="application/xml"/>
  <Override PartName="/xl/workbook.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet.main+xml"/>
  <Override PartName="/xl/worksheets/sheet1.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.worksheet+xml"/>
  <Override PartName="/docProps/core.xml" ContentType="application/vnd.openxmlformats-package.core-properties+xml"/>
  <Override PartName="/docProps/app.xml" ContentType="application/vnd.openxmlformats-officedocument.extended-properties+xml"/>
</Types>`;
}
function corePropsXML(){
  const now = new Date().toISOString();
  return `<?xml version="1.0" encoding="UTF-8"?>
<cp:coreProperties xmlns:cp="http://schemas.openxmlformats.org/package/2006/metadata/core-properties"
 xmlns:dc="http://purl.org/dc/elements/1.1/"
 xmlns:dcterms="http://purl.org/dc/terms/"
 xmlns:dcmitype="http://purl.org/dc/dcmitype/"
 xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <dc:creator>Editor Filiaciones</dc:creator>
  <cp:lastModifiedBy>Editor Filiaciones</cp:lastModifiedBy>
  <dcterms:created xsi:type="dcterms:W3CDTF">${now}</dcterms:created>
  <dcterms:modified xsi:type="dcterms:W3CDTF">${now}</dcterms:modified>
</cp:coreProperties>`;
}
function appPropsXML(){
  return `<?xml version="1.0" encoding="UTF-8"?>
<Properties xmlns="http://schemas.openxmlformats.org/officeDocument/2006/extended-properties"
 xmlns:vt="http://schemas.openxmlformats.org/officeDocument/2006/docPropsVTypes">
  <Application>Microsoft Excel</Application>
</Properties>`;
}
function fileNameForFiliacion(f, idx){
  const nombre = (f.nombre||"").trim();
  const ap1 = (f.apellidos||"").trim().split(/\s+/)[0] || "";
  let base = [nombre, ap1].filter(Boolean).join(" ").trim();
  if(!base) base = `filiacion_${idx+1}`;
  base = base.replace(/[\\/:*?"<>|]/g, "_"); // sanea caracteres inv√°lidos
  return `${base}.xlsx`;
}
function makeXLSXFromFiliacion(f){
  const z = new ZipWriter();
  z.addFile("[Content_Types].xml", contentTypesXML());
  z.addFile("_rels/.rels", rootRelsXML());
  z.addFile("docProps/core.xml", corePropsXML());
  z.addFile("docProps/app.xml", appPropsXML());
  z.addFile("xl/workbook.xml", workbookXML());
  z.addFile("xl/_rels/workbook.xml.rels", workbookRelsXML());
  z.addFile("xl/worksheets/sheet1.xml", sheetXMLForFiliacion(f));
  return z.finalize();
}

/* =================== XLSX Import (ZIP reader + deflate-raw si es necesario) =================== */
async function importXlsxFiles(fileList){
  for(const file of fileList){
    try{
      const buf = new Uint8Array(await file.arrayBuffer());
      const zip = new ZipReader(buf);
      // 1) workbook.xml -> localizar la hoja "Resumen"
      const wbXml = await zip.readText("xl/workbook.xml");
      const wb = new DOMParser().parseFromString(wbXml, "application/xml");
      const sheets = Array.from(wb.getElementsByTagName("sheet"));
      const resumen = sheets.find(s=> (s.getAttribute("name")||"").toLowerCase() === "resumen");
      if(!resumen) throw new Error("No se encontr√≥ la hoja 'Resumen' en el XLSX.");
      const rid = resumen.getAttributeNS("http://schemas.openxmlformats.org/officeDocument/2006/relationships","id") || resumen.getAttribute("r:id");
      if(!rid) throw new Error("No se pudo resolver r:id de la hoja 'Resumen'.");
      // 2) workbook rels -> target de rId
      const relsXml = await zip.readText("xl/_rels/workbook.xml.rels");
      const rels = new DOMParser().parseFromString(relsXml, "application/xml");
      const rel = Array.from(rels.getElementsByTagName("Relationship")).find(r=> r.getAttribute("Id")===rid);
      if(!rel) throw new Error("No se pudo encontrar el Relationship de la hoja.");
      let target = rel.getAttribute("Target");
      if(!target.startsWith("worksheets/")) target = "worksheets/sheet1.xml"; // fallback
      const sheetXml = await zip.readText("xl/" + target);
      // 3) sharedStrings (opcional)
      let shared = [];
      if(await zip.exists("xl/sharedStrings.xml")){
        const sXml = await zip.readText("xl/sharedStrings.xml");
        const sDoc = new DOMParser().parseFromString(sXml, "application/xml");
        shared = Array.from(sDoc.getElementsByTagName("si")).map(si=>{
          // concatena todos los <t> (posible rich text)
          return Array.from(si.getElementsByTagName("t")).map(t=>t.textContent||"").join("");
        });
      }
      // 4) Parse sheet: columna A (etiquetas) y B (valores)
      const ws = new DOMParser().parseFromString(sheetXml, "application/xml");
      const cells = Array.from(ws.getElementsByTagName("c"));
      const byRow = {}; // rowIndex -> {A:label, B:value}
      function readCell(c){
        const t = c.getAttribute("t"); // 's' shared, 'inlineStr', etc.
        const v = c.getElementsByTagName("v")[0];
        if(t==="s"){ const idx = v ? parseInt(v.textContent||"0",10) : 0; return shared[idx] ?? ""; }
        if(t==="inlineStr"){ const is = c.getElementsByTagName("is")[0]; if(!is) return ""; const tnode = is.getElementsByTagName("t")[0]; return tnode? tnode.textContent || "" : ""; }
        return v ? v.textContent || "" : "";
      }
      cells.forEach(c=>{
        const ref = c.getAttribute("r")||""; // ej. A12
        const m = ref.match(/^([A-Z]+)(\d+)$/); if(!m) return;
        const col = m[1]; const row = parseInt(m[2],10);
        const val = readCell(c);
        byRow[row] = byRow[row] || {};
        if(col==="A") byRow[row].A = val;
        else if(col==="B") byRow[row].B = val;
      });
      // 5) Construir filiaci√≥n desde etiquetas conocidas
      const map = {};
      Object.values(byRow).forEach(r=>{
        if(!r || !r.A) return;
        map[r.A.trim()] = (r.B||"").trim();
      });
      const f = nuevaFiliacion();
      f.nombre   = map["Nombre"] || "";
      f.apellidos= map["Apellidos"] || "";
      f.tipoDoc  = map["Tipo de documento"] || "";
      f.dni      = map["N¬∫ Documento"] || "";
      f.padres   = map["Nombre de los Padres"] || "";
      f.domicilio= map["Domicilio"] || "";
      f.telefono = map["Tel√©fono"] || "";

      state.filiaciones.push(f); save(); renderFiliaciones();
    }catch(err){
      alert(`No se pudo importar ‚Äú${file.name}‚Äù: ${err.message}`);
    }
  }
}

/* ---- ZIP Reader con soporte DEFLATE usando DecompressionStream si existe ---- */
class ZipReader{
  constructor(u8){ this.u8 = u8; this.dv = new DataView(u8.buffer); }
  async readText(path){ const data = await this.readFile(path); return fromUTF8(data); }
  async exists(path){ try{ await this.readFile(path); return true; }catch{ return false; } }
  async readFile(path){
    // Localiza central directory y busca 'path'
    const eocd = this.findEOCD();
    if(!eocd) throw new Error("EOCD no encontrado");
    const cdOff = eocd.cdOffset, cdSize = eocd.cdSize;
    const cdEnd = cdOff + cdSize;
    let p = cdOff;
    while(p < cdEnd){
      const sig = this.dv.getUint32(p, true); if(sig !== 0x02014b50) break; // central file header
      const compMethod = this.dv.getUint16(p+10, true);
      const csize = this.dv.getUint32(p+20, true);
      const usize = this.dv.getUint32(p+24, true);
      const nameLen = this.dv.getUint16(p+28, true);
      const extraLen= this.dv.getUint16(p+30, true);
      const commLen = this.dv.getUint16(p+32, true);
      const lhoff   = this.dv.getUint32(p+42, true);
      const name = fromUTF8(this.u8.slice(p+46, p+46+nameLen));
      const next = p + 46 + nameLen + extraLen + commLen;
      if(name === path){
        // lee local header
        const sig2 = this.dv.getUint32(lhoff, true); if(sig2 !== 0x04034b50) throw new Error("Local header inv√°lido");
        const nlen = this.dv.getUint16(lhoff+26, true);
        const xlen = this.dv.getUint16(lhoff+28, true);
        const dataStart = lhoff + 30 + nlen + xlen;
        const comp = this.u8.slice(dataStart, dataStart + csize);
        if(compMethod === 0){ // STORE
          return comp;
        }else if(compMethod === 8){ // DEFLATE
          if(typeof DecompressionStream === "undefined"){
            throw new Error("Este navegador no soporta DecompressionStream (deflate). Prueba en Chrome/Edge modernos.");
          }
          const ds = new DecompressionStream('deflate-raw');
          const ab = await new Response(new Blob([comp]).stream().pipeThrough(ds)).arrayBuffer();
          return new Uint8Array(ab);
        }else{
          throw new Error("M√©todo de compresi√≥n no soportado: "+compMethod);
        }
      }
      p = next;
    }
    throw new Error("Archivo no encontrado en el ZIP: "+path);
  }
  findEOCD(){
    // Busca 0x06054b50 desde el final (m√°x 64KB)
    const u8 = this.u8;
    const start = Math.max(0, u8.length - 0xFFFF);
    for(let i=u8.length-22; i>=start; i--){
      if(this.dv.getUint32(i, true) === 0x06054b50){
        const entries = this.dv.getUint16(i+10, true);
        const cdSize  = this.dv.getUint32(i+12, true);
        const cdOffset= this.dv.getUint32(i+16, true);
        return {entries, cdSize, cdOffset, offset:i};
      }
    }
    return null;
  }
}

/* =================== UI: Filiaciones en desplegables =================== */
function renderFiliaciones(){
  const cont = document.getElementById('filiaciones'); cont.innerHTML="";
  state.filiaciones.forEach((f,i)=>{
    const titulo = (f.nombre||f.apellidos) ? `${(f.nombre||'').trim()} ${(f.apellidos||'').trim().split(/\s+/)[0]||''}`.trim() : `Filiaci√≥n ${i+1}`;
    const det=document.createElement('details'); det.className="f-item";
    if(i===0) det.open = true; // la primera abierta por comodidad
    det.innerHTML=`
      <summary>
        <span class="tag">#${i+1}</span>
        <span class="title">${titulo||('Filiaci√≥n '+(i+1))}</span>
        <span class="sub">(${(f.tipoDoc||'doc')} ¬∑ ${(f.dni||'‚Äî')})</span>
        <span class="caret"></span>
      </summary>
      <div class="details-body">
        <div class="row">
          <div class="col"><label>Nombre</label><input data-k="nombre" data-i="${i}" value="${f.nombre||''}" placeholder="Nombre" /></div>
          <div class="col"><label>Apellidos</label><input data-k="apellidos" data-i="${i}" value="${f.apellidos||''}" placeholder="Apellidos" /></div>
          <div class="col"><label>Tipo de documento</label><input data-k="tipoDoc" data-i="${i}" value="${f.tipoDoc||''}" placeholder="DNI, NIE, Pasaporte..." /></div>
          <div class="col"><label>N¬∫ Documento</label><input data-k="dni" data-i="${i}" value="${f.dni||''}" placeholder="N√∫mero" /></div>
          <div class="col"><label>Nombre de los Padres</label><input data-k="padres" data-i="${i}" value="${f.padres||''}" placeholder="Ej.: Juan y Emilia" /></div>
          <div class="col"><label>Domicilio</label><input data-k="domicilio" data-i="${i}" value="${f.domicilio||''}" placeholder="Calle, n¬∫..." /></div>
          <div class="col"><label>Tel√©fono</label><input data-k="telefono" data-i="${i}" value="${f.telefono||''}" placeholder="Tel√©fono" inputmode="tel" /></div>
        </div>
        <div class="btn-row" style="margin-top:8px">
          <button class="btn ghost tiny" data-up="${i}" title="Subir">‚Üë</button>
          <button class="btn ghost tiny" data-down="${i}" title="Bajar">‚Üì</button>
          <button class="btn secondary tiny" data-coletilla="${i}" title="Insertar coletilla">‚ûú Coletilla</button>
          <button class="btn secondary tiny" data-xlsx="${i}" title="Descargar XLSX">‚¨áÔ∏è XLSX</button>
          <button class="btn danger tiny" data-del="${i}" title="Eliminar">üóëÔ∏è</button>
        </div>
      </div>
    `;
    cont.appendChild(det);
  });

  // Edici√≥n
  cont.querySelectorAll('input[data-k]').forEach(inp=>{
    inp.addEventListener('input', e=>{
      const i=+e.target.dataset.i, k=e.target.dataset.k; state.filiaciones[i][k]=e.target.value; save();
      // refresca t√≠tulo del summary si cambia nombre/apellidos/tipo/dni
      if(k==="nombre"||k==="apellidos"||k==="tipoDoc"||k==="dni"){ renderFiliaciones(); }
    }, {passive:true});
  });
  // Acciones
  cont.querySelectorAll('button[data-del]').forEach(b=>b.onclick=()=>{ const idx=+b.dataset.del; state.filiaciones.splice(idx,1); save(); renderFiliaciones(); });
  cont.querySelectorAll('button[data-up]').forEach(b=>b.onclick=()=>{ const i=+b.dataset.up; if(i<=0)return; [state.filiaciones[i-1],state.filiaciones[i]]=[state.filiaciones[i],state.filiaciones[i-1]]; save(); renderFiliaciones();});
  cont.querySelectorAll('button[data-down]').forEach(b=>b.onclick=()=>{ const i=+b.dataset.down; if(i>=state.filiaciones.length-1)return; [state.filiaciones[i+1],state.filiaciones[i]]=[state.filiaciones[i],state.filiaciones[i+1]]; save(); renderFiliaciones();});
  cont.querySelectorAll('button[data-coletilla]').forEach(b=>b.onclick=()=>{ const f=state.filiaciones[+b.dataset.coletilla]; insertAtCursor(document.getElementById('doc'), buildColetillaFromFiliacion(f)); persistDoc(); });
  cont.querySelectorAll('button[data-xlsx]').forEach(b=>b.onclick=()=>{ const idx=+b.dataset.xlsx; const f=state.filiaciones[idx]; const xlsx=makeXLSXFromFiliacion(f); download(fileNameForFiliacion(f, idx), xlsx, "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"); });
}

/* =================== Coletilla por ficha (sin loc/prov) =================== */
function buildColetillaFromFiliacion(f){
  const nom=[f.nombre,f.apellidos].filter(Boolean).join(' ').trim()||"‚Äî";
  const tipo=(f.tipoDoc||"documento").trim();
  const num=(f.dni||"‚Äî").trim(); const dom=f.domicilio?.trim()||"‚Äî";
  const tel=f.telefono?.trim()||"‚Äî";
  return `${nom}, con ${tipo.toLowerCase()} n√∫mero ${num}, domicilio ${dom}, tel√©fono ${tel}.\n`;
}

/* =================== Persistencia documento =================== */
function persistDoc(){ state.titulo=$('#titulo').value; state.doc=$('#doc').value; save(); }

/* =================== Eventos Documento =================== */
document.getElementById('copyBtn').onclick=async()=>{ try{ await navigator.clipboard.writeText(document.getElementById('doc').value); alert("Contenido copiado."); }catch{ alert("No se pudo copiar autom√°ticamente."); } };
document.getElementById('odtBtn').onclick=()=>{ const title = state.titulo||"Documento"; const body = document.getElementById('doc').value||""; const odt=makeODT(title, body); download(`${(title||"documento").toLowerCase().replace(/[^\w]+/g,'_')||'documento'}.odt`, odt, "application/vnd.oasis.opendocument.text"); };
document.getElementById('printBtn').onclick=()=>window.print();

document.getElementById('saveProjectBtn').onclick=()=>{
  const json = toUTF8(JSON.stringify(state, null, 2));
  download(`proyecto_filiaciones_${todayISO()}.json`, json, "application/json");
};
document.getElementById('loadProjectBtn').onclick=()=>{ document.getElementById('loadProjectInput').click(); };
document.getElementById('loadProjectInput').addEventListener('change', async (e)=>{
  const file = e.target.files?.[0]; if(!file) return;
  try{
    const data = JSON.parse(await file.text());
    if(!data || !Array.isArray(data.filiaciones)) throw new Error("Formato inv√°lido");
    state.filiaciones = data.filiaciones.map(f=>Object.assign(nuevaFiliacion(), f));
    state.titulo = data.titulo || ""; state.doc = data.doc || "";
    save(); $('#titulo').value = state.titulo; $('#doc').value = state.doc; renderFiliaciones();
    alert("Proyecto cargado correctamente.");
  }catch(err){ alert("No se pudo cargar el proyecto: " + err.message); }
  finally{ e.target.value=""; }
});

/* =================== Importar XLSX (uno o varios) =================== */
document.getElementById('importXlsxBtn').onclick=()=>{ document.getElementById('importXlsxInput').click(); };
document.getElementById('importXlsxInput').addEventListener('change', async (e)=>{
  const files = e.target.files; if(!files?.length) return;
  await importXlsxFiles(files);
  e.target.value="";
});

/* =================== Botones de lista =================== */
document.getElementById('addFBtn').onclick=()=>{ state.filiaciones.push(nuevaFiliacion()); save(); renderFiliaciones(); };
document.getElementById('clearFBtn').onclick=()=>{ if(confirm("¬øEliminar TODAS las filiaciones?")){ state.filiaciones=[]; save(); renderFiliaciones(); } };

/* =================== Init =================== */
(function init(){
  load();
  if(!Array.isArray(state.filiaciones) || !state.filiaciones.length){ state.filiaciones=[nuevaFiliacion()]; }
  $('#titulo').value = state.titulo||"";
  $('#doc').value = state.doc||"";
  renderFiliaciones();
  renderColetillas();
  // atajo m√≥vil/desktop: Ctrl/Cmd+S => ODT
  window.addEventListener('keydown', (e)=>{
    if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){ e.preventDefault(); document.getElementById('odtBtn').click(); }
  }, {passive:false});
})();
</script>
</body>
</html>
